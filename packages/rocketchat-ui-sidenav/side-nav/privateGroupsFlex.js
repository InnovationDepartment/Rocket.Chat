var createCookie;

var emptyList = function () {
  document.getElementById('brandsearchlist').innerHTML = '';
};

Template.privateGroupsFlex.helpers({
  tRoomMembers: function() {
    return t('Members');
  },
  selectedUsers: function() {
    return Template.instance().selectedUsers.get();
  },
  selectedBrand: function() {
    return Template.instance().selectedBrand.get();
  },
  groupName: function() {
    return Template.instance().groupName.get();
  },
  name: function() {
    return Template.instance().selectedUserNames[this.valueOf()];
  },
  brand: function() {
    console.log ("-----------");
    console.log(Template.instance().selectedUserNames);
    console.log(this.valueOf());
    console.log("-----------");
    // need to get the brand name from the brandid (this.valueof)
    return this.valueOf();
  },
  autocompleteSettings: function() {
    return {
      limit: 10,
      rules: [
        {
          collection: 'brands',
          subscription: 'brandAutocomplete',
          field: 'name',
          template: Template.brandSearch,
          noMatchTemplate: Template.brandSearchEmpty,
          matchAll: true,
          selector: function(match) {
            return {
              name: match
            };
          },
          sort: 'name'
        }
      ]
    };
  }
});

function readCookie(name) {
  var nameEQ = name + "=";
  var ca = document.cookie.split(';');
  for (var i=0; i < ca.length; i++) {
    var c = ca[i];
    while (c.charAt(0)==' ')
      c = c.substring(1,c.length);
    if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
  }

  return null;
}

createCookie = function(name, value, days) {
  var expires;
  var date, expires;
  if (days) {
    date = new Date;
    date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
    expires = '; expires=' + date.toGMTString();
  } else {
    expires = '';
  }
  document.cookie = name + '=' + value + expires + '; path=/';
};

Template.privateGroupsFlex.events({
  'autocompleteselect #pvt-group-members': function(event, instance, doc) {
    instance.selectedUsers.set(instance.selectedUsers.get().concat(doc.username));
    instance.selectedUserNames[doc.username] = doc.name;
    event.currentTarget.value = '';
    return event.currentTarget.focus();
  },
  'click .remove-room-member': function(e, instance) {
    var self, users, brands;
    self = this;
    brands = Template.instance().selectedBrand.get();
    brands = _.reject(template.instance().selectedBrand.get(), function(_id) {
      return _id === self.value.Of();
    });
    Template.instance().selectedBrand.set(brands);
    return $('#pvt-group-members').focus();
  },
  'click .cancel-pvt-group': function(e, instance) {
    return SideNav.closeFlex(function() {
      return instance.clearForm();
    });
  },
  'click header': function(e, instance) {
    return SideNav.closeFlex(function() {
      return instance.clearForm();
    });
  },
  'mouseenter header': function() {
    return SideNav.overArrow();
  },
  'mouseleave header': function() {
    return SideNav.leaveArrow();
  },
  'keyup input[type="text"]': function(e, instance) {
    var data, xhr;
    if (document.querySelector('.input-line .search').value === '') {
      document.getElementById('brandsearchlist').innerHTML = '';
      return;
    }
    data = {
      size: 200,
      query: {
        filtered: {
          query: {
            wildcard: {
              accountnameSearch:  "*" + document.querySelector('.input-line .search').value + "*"
            }
          }
        }
      }
    };
    xhr = new XMLHttpRequest;
    xhr.addEventListener('load', Template.instance().loadedResults);
    xhr.open('POST', instance.dojoMojoUrl + '/search');
    xhr.setRequestHeader('x-requested-with', 'XMLHttpRequest');
    xhr.setRequestHeader('accept', '*/*');
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.setRequestHeader('accept-language', 'en-US,en;q=0.8');
    xhr.setRequestHeader('authtoken', readCookie('remember'));
    return xhr.send(JSON.stringify(data));
  }
});

Template.privateGroupsFlex.onCreated(function() {
  var instance;
  instance = this;
  // grab environment
  instance.dojoMojoUrl = new ReactiveVar();
  Meteor.call('getDojoMojoEnv', function(err, dojomojoUrl) { instance.dojoMojoUrl = dojomojoUrl });
  instance.selectedUsers = new ReactiveVar([]);
  instance.selectedBrand = new ReactiveVar([]);
  instance.selectedUserNames = {};
  instance.error = new ReactiveVar([]);
  instance.groupName = new ReactiveVar([]);
  instance.myBrandId = readCookie('brand');
  instance.myBrandName = readCookie('brand');
  instance.newResultItem = function (brand) {
    var accountname = brand._source.accountname;
    var id = brand._id;
    var result = document.createElement('li');

    result.innerHTML = accountname;
    result.className = 'result';
    result.style = 'color: #9ec8c4; font-weight: bold; font-size: 12px; padding: 10px;';
    result.onclick = function(e) {
       // add brandId to group chat
      instance.selectedBrand.set({ id: id, name: accountname });
      instance.createChat();
    // debugger;
       // now remove list display
       emptyList();
    };

    return result;
  };

  instance.getUsersForBrand = function(brandId, callback) {
      var xhr = new XMLHttpRequest;
      xhr.addEventListener('load', callback);
      xhr.open('POST', instance.dojoMojoUrl + '/brands-users');
      xhr.setRequestHeader('brandid', instance.myBrandId);
      xhr.setRequestHeader('x-requested-with', 'XMLHttpRequest');
      xhr.setRequestHeader('accept', '*/*');
      xhr.setRequestHeader('accept-language', 'en-US,en;q=0.8');
      xhr.setRequestHeader('x-requested-with', 'XMLHttpRequest');
      xhr.setRequestHeader('authtoken', readCookie('remember'));
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.send(JSON.stringify({ brandId: brandId}));
  };

  instance.loadedResults = function(e) {
    var hits = JSON.parse(e.target.response).hits.hits;
    if (hits.length > 0) {
      var resultslist = document.createElement('ul');
      resultslist.id = 'resultslist';
      for (var i = 0; i < hits.length && i < 10; i++) {
        resultslist.appendChild(instance.newResultItem(hits[i]));
      }
      document.getElementById('brandsearchlist').innerHTML = '';
      document.getElementById('brandsearchlist').style = 'border-color: #d5ecdb; border-style: solid; border-width: 1px; background-color: #fff; color: #000;';
      document.getElementById('brandsearchlist').appendChild(resultslist);
    }
    else {
      //document.getElementById('resultslist').innerHTML = '';
    }
  };

  instance.cleanRoomName = function(name) {
    return name.replace(/[^a-zA-Z0-9]/g, '-');
  };

  instance.createChat = function() {
    var err = SideNav.validate();

    var response, chatUserIds;
    instance.getUsersForBrand(instance.selectedBrand.get().id, function(response) {
      response = JSON.parse(response.target.response);
      chatUserIds = response.chatuserids;
      var name = response.accountname + ' and ' +  instance.selectedBrand.get().name;
      for (var i = 0; i < chatUserIds.length; i++) {
        instance.selectedUsers.set(instance.selectedUsers.get().concat(chatUserIds[i]));
      }

      name = instance.cleanRoomName(name);
      instance.groupName.set(name);

      if (!err) {
        Meteor.call('createPrivateGroup', name, chatUserIds, function(err, result) {
          FlowRouter.go('group', { name: name })
          SideNav.closeFlex();
          instance.clearForm();
        });
      }
    });
  };

  return instance.clearForm = function() {
    instance.error.set([]);
    instance.groupName.set('');
    instance.selectedUsers.set([]);
    instance.find('#pvt-group-name').value = '';
    return instance.find('#pvt-group-members').value = '';
  };
});


